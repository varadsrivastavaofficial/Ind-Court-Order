# Deploy to Firebase App Hosting
name: Deploy to Firebase App Hosting

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ["main"]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to Firebase
permissions:
  contents: 'read'
  id-token: 'write'

jobs:
  deploy:
    runs-on: ubuntu-latest
    # These are the permissions the workflow needs to deploy to Firebase.
    # You will need to grant these permissions to your service account in your Google Cloud project.
    # The service account needs the following roles:
    # - Firebase App Hosting Admin (roles/firebaseapphosting.admin)
    # - Service Account User (roles/iam.serviceAccountUser)
    # - Cloud Run Invoker (roles/run.invoker)
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # This step is where the magic happens. It uses Workload Identity Federation
      # to authenticate with Google Cloud using a GitHub Actions OIDC token.
      # You will need to create a Workload Identity Pool and Provider in your
      # Google Cloud project and configure it to trust your GitHub repository.
      # You will also need to create a service account and grant it the necessary
      # permissions to deploy to Firebase App Hosting.
      #
      # Finally, you need to add the following secrets to your GitHub repository:
      # - PROJECT_ID: Your Firebase project ID.
      # - WIF_PROVIDER: The full resource name of your Workload Identity Provider.
      #   (e.g., projects/1234567890/locations/global/workloadIdentityPools/my-pool/providers/my-provider)
      # - WIF_SERVICE_ACCOUNT: The email of the service account.
      #   (e.g., firebase-deployer@my-project.iam.gserviceaccount.com)
      - name: Google Auth
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ secrets.WIF_PROVIDER }}'
          service_account: '${{ secrets.WIF_SERVICE_ACCOUNT }}'

      # The Firebase CLI is used to deploy the app.
      - name: Deploy to Firebase
        uses: firebase/actions/setup-and-deploy@v1
        with:
          project_id: '${{ secrets.PROJECT_ID }}'
          # This is the ID of your App Hosting backend. You can find it in the Firebase console.
          # The default ID is 'next-app', but you may need to update it if you have changed it.
          app_hosting_site_id: 'next-app'
